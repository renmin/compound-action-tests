<!-- =========================
File: tests/example_basic.html
Purpose: Simple example built on the template; validates click + type actions
How to use:
  1) Open this page in the container browser.
  2) Your runner performs: click on the green target, then type the expected string into the input.
  3) Trigger "Run Assertions" (by remote click or programmatic click on #btn-verify).
========================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Example — Click + Type</title>
  <style>
    body{margin:0;font:14px/1.4 ui-sans-serif,system-ui}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:16px}
    .big-result{display:flex;align-items:center;justify-content:center;height:140px;border-radius:12px;font-weight:800;font-size:32px}
    .ok{background:#12b886;color:#fff}
    .fail{background:#fa5252;color:#fff}
    .stage{height:360px;border:2px dashed #cbd5e1;border-radius:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
    .target{display:flex;align-items:center;justify-content:center;border-radius:12px;background:#d3f9d8;border:2px solid #37b24d;font-weight:800;letter-spacing:.5px;cursor:pointer;user-select:none}
    .target.clicked{background:#b2f2bb}
    .box{display:flex;flex-direction:column;gap:6px}
    .kvs{display:grid;grid-template-columns:110px 1fr;gap:8px;align-items:center}
    .k{color:#6b7280;text-align:right}
    .v{font-weight:600}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:0;background:#111;color:#fff;padding:16px 22px;border-radius:12px;font-weight:800;cursor:pointer;font-size:18px}
    .log{height:220px;overflow:auto;background:#0b1020;color:#cbe0ff;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;border-radius:10px;padding:10px}
    .list{display:grid;gap:8px}
    .row{display:flex;justify-content:space-between;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700}
    .badge.ok{background:#12b886;color:#fff}
    .badge.fail{background:#fa5252;color:#fff}
    .qr{display:flex;align-items:center;justify-content:center;min-height:160px}
    .qr canvas{image-rendering: pixelated; max-width: 95vw; max-height: 85vh; width:auto; height:auto}
    .muted{color:#6b7280}
  </style>
</head>
<body>

  <div class="wrap">
    <h1>Example — Click + Type</h1>
    <p class="muted">This example verifies two actions from your remote runner: a click on the green target, and typing a specific string into the input box.</p>

    <div class="grid">
      <div class="card">
        <h2>Run Meta</h2>
        <div class="kvs" id="meta">
          <div class="k">Test</div><div class="v" data-k="name">—</div>
          <div class="k">Run ID</div><div class="v" data-k="runId">—</div>
          <div class="k">Started</div><div class="v" data-k="startedAt">—</div>
          <div class="k">Actions</div><div class="v" data-k="actions">0</div>
          <div class="k">Pass</div><div class="v" data-k="pass">0</div>
          <div class="k">Fail</div><div class="v" data-k="fail">0</div>
        </div>
        <hr />
        <div class="toolbar">
          <button class="btn" id="btn-verify">Run Assertions</button>
          <button class="btn" id="btn-reset" onclick="location.reload()">Reset</button>
        </div>
        <p class="muted" style="margin-top:6px">Expected typed string can be provided via <code>?text=hello</code> (default: "hello").</p>
      </div>

      <div class="card">
        <div class="big-result" id="bigResult">WAITING</div>
        <div class="list" id="cases"></div>
        <h2 style="margin-top:12px">Logs</h2>
        <pre class="log" id="log"></pre>
        <h2 style="margin-top:12px">QR Result</h2>
        <div class="qr" id="qr"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Validation Stage</h2>
      <div class="stage" id="stage">
        <div class="target" id="clickTarget" tabindex="0">CLICK ME</div>
        <div class="box">
          <label for="tbox"><strong>Type into this box</strong></label>
          <input id="tbox" type="text" placeholder="type here…" style="padding:10px;border-radius:10px;border:1px solid #94a3b8;outline:none;font-size:16px" />
          <small class="muted">Focus is set programmatically on load to aid remote typing.</small>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
  ;(() => {
    const qs = new URLSearchParams(location.search)
    const expectedText = qs.get('text') || 'hello'
    const testName = 'Example: click + type'

    // Harness (minimal re-implementation here to keep this file standalone)
    const state = {
      testName: testName,
      runId: (qs.get('run') || (Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8))).toUpperCase(),
      startedAt: new Date().toISOString(),
      cases: [], logs: []
    }
    const $ = sel => document.querySelector(sel)
    const $$ = sel => Array.from(document.querySelectorAll(sel))
    const $meta = $('#meta'), $big = $('#bigResult'), $cases = $('#cases'), $log = $('#log'), $qr = $('#qr')
    const setMeta=(k,v)=>{ const el=$meta.querySelector(`[data-k="${k}"]`); if(el) el.textContent=String(v) }
    const log = m=>{ const line=`[${new Date().toISOString()}] ${m}`; state.logs.push(line); $log.textContent += line+'\n'; $log.scrollTop=$log.scrollHeight };
    if(window.innerWidth!==1280||window.innerHeight!==960){ log(`Window size=${window.innerWidth}x${window.innerHeight} (recommended 1280x960)`) }
    const reg = (name,expected,fn)=> state.cases.push({name,expected,fn,pass:null,actual:null,error:null})
    const deepEqual=(a,b)=>{ try{ return JSON.stringify(a)===JSON.stringify(b) }catch{ return false } }
    const render = ()=>{ $cases.innerHTML=''; for(const c of state.cases){ const d=document.createElement('div'); d.className='row'; d.innerHTML=`<div><span class=\"name\">${c.name}</span><div class=\"exp\">exp: ${escapeHtml(JSON.stringify(c.expected))}</div></div><div class=\"badge ${c.pass? 'ok':'fail'}\">${c.pass? 'PASS':'FAIL'}</div>`; $cases.appendChild(d) } }
    const escapeHtml = s=> s.replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))

    // Widgets
    const clickTarget = $('#clickTarget')
    const tbox = $('#tbox')
    tbox.focus()
    clickTarget.addEventListener('click', ()=>{ clickTarget.classList.add('clicked'); log('clickTarget clicked') })

    // Assertions
    reg('click target hit', {clicked:true}, async ()=> ({clicked: clickTarget.classList.contains('clicked')}))
    reg('typed text equals', {value: expectedText}, async ()=> ({value: tbox.value}))

    setMeta('name', state.testName); setMeta('runId', state.runId); setMeta('startedAt', state.startedAt)

    async function run(){
      let pass=0, fail=0
      for(const c of state.cases){
        try{ c.actual = await c.fn(); c.pass = deepEqual(c.actual, c.expected); c.error=null }catch(e){ c.pass=false; c.error=String(e) }
        c.pass? pass++: fail++
      }
      setMeta('actions', state.cases.length); setMeta('pass', pass); setMeta('fail', fail)
      $big.className='big-result '+(fail===0?'ok':'fail'); $big.textContent = fail===0?'PASS':'FAIL'
      render(); buildQR(fail===0)
    }

    function buildQR(ok){
      const payload = {
        type:'remote-browser-test', version:1, test:state.testName,
        runId:state.runId, startedAt:state.startedAt, endedAt:new Date().toISOString(), pass:ok,
        expected:{ text: expectedText },
        summary: state.cases.map(c=>({name:c.name, pass:c.pass, expected:c.expected, actual:c.actual, error:c.error})),
        log: state.logs.slice(-80)
      }
      const text = JSON.stringify(payload)
      $qr.innerHTML=''; new QRCode($qr,{text, width:180, height:180, correctLevel: QRCode.CorrectLevel.H})
      log('QR encoded length='+text.length)
    }

    // Wire Verify button
    document.getElementById('btn-verify').addEventListener('click', run)

  })()
  </script>
</body>
</html>
